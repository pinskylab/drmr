{
  "hash": "d9dd5b36124ecbdca95c8d4823f43667",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Theoretical Background\"\nauthor: Lucas da Cunha Godoy\nbibliography: [notes.bib, zim.bib]\nexecute:\n  warning: false\n  error: false\nengine: knitr\nvignette: >\n  %\\VignetteIndexEntry{theory}\n  %\\VignetteEngine{quarto::html}\n  %\\VignetteEncoding{UTF-8}\nknitr:\n  opts_chunk:\n    collapse: true\n    comment: '#>'\n---\n\n\n\n## Notation {#sec-notation}\n\n\nBefore diving into coding, let us establish some common notation so we\nunderstand what we are estimating.\n\n\nEcological data on species density often exhibits zeros. This occurs because\nspecies may be patchily distributed or because sampling methods may fail to\ndetect individuals at low densities. Since densities are continuous non-negative\nquantities, we cannot use discrete probability distributions (e.g., Poisson or\nBinomial) to model this type of phenomena. However, standard continuous\nprobability distributions assign a zero probability to specific values (that is,\n$\\mathrm{Pr}(Y_{t, i} = c) = 0$, for any constant $c$ and continuous probability\ndistribution). To address this, we use zero-augmented (Hurdle/Delta) models,\nwhich explicitly account for the excess zeros by combining a discrete and a\ncontinuous probability distribution through two components:\n\n1. **A probability of observing a zero (or probability of absence)**: This\n   accounts for the \"true\" absence or non-detection of the species.\n\n1. **A continuous distribution for positive values**: This models the density of\n   the species when it is present.\n\n\nFormally, let $Y_{t, i}$ be a random variable representing the density\n(individuals per unit of area) of a focal species at time $t$ and patch/site\n$i$. We denote realizations (i.e., what we observe) of $Y_{t, i}$ by $y_{t,\ni}$. We define a _zero-augmented_ probability density function (pdf) as follows:\n$$ \nf(y_{t, i} \\mid \\mu_{t, i}, \\phi,\n\\rho_{t, i}) = \\begin{cases} \\rho_{t, i}, & \\text{ if } y_{t, i} = 0, \\\\\n(1 - \\rho_{t, i}) g(y_{t, i} \\mid \\mu_{t, i}, \\phi), & \\text{ if } y_{t,\ni} > 0,  \\end{cases}\n$$ {#eq-za_dens}\nwhere\n\n* $\\rho_{t, i} = \\mathrm{Pr}(Y_{t, i} = 0)$ is the probability of observing a\n  zero density.\n  \n* $g(\\cdot \\mid \\mu_{t, i}, \\phi)$ is the pdf of a continuous probability\n  distribution with expected value (or theoretical mean) $\\mu_{t, i}$ and\n  additional parameter $\\phi$. This distribution represents the densities of the\n  species when they are present.\n\n\nIn @eq-za_dens, we can choose different probability distributions to specify the\npdf $g(\\cdot \\mid \\mu_{t, i}, \\phi)$. Popular choices include the Log-Normal,\nLog-Logistic, and Gamma distributions, which can be parametrized in terms of\ntheir mean facilitating modeling [@ye2021comparisons].\n\n\n## Species Distribution Models {#sec-sdm}\n\n\nA typical SDM based on @eq-za_dens relates the parameters of the zero-augmented\ndistribution to environmental covariates. Let $t = 1, \\ldots, T$ represent time\npoints and $i = 1, \\ldots, P$ represents patches/sites. The first assumptions of\nSDMs is that $Y_{1, 1}, \\ldots, Y_{T, P}$ are independent random variables when\nconditioned on the environmental factors. From here on, only SDMs based on\n(generalized) linear models will be discussed.\n\n\nWe define as $\\mathbf{x}^{(1)}_{t, i}$ a vector of $p_1$ covariates related to\nthe probability of observing a zero density at time $t$ and site $i$, and\n$\\mathbf{x}^{(2)}_{t, i}$ as a vector of $p_2$ covariates related to the\n(theoretical) mean density when the species is present. Note that,\n$\\mathbf{x}^{(1)}_{t, i}$ and $\\mathbf{x}^{(2)}_{t, i}$ may depend on a\ndifferent set of environmental factors.\n\n\nWe define linear-predictors as follows:\n$$\n\\begin{aligned}\n\\eta^{(1)}_{t, i} & = \\boldsymbol{\\beta}^{(1)}\\mathbf{x}^{(1)}_{t, i} \\\\\n\\eta^{(1)}_{t, i} & = \\boldsymbol{\\beta}^{(2)}\\mathbf{x}^{(2)}_{t, i},\n\\end{aligned}\n$$ {#eq-linpreds}\nwhere $\\boldsymbol{\\beta}^{(1)}$ and $\\boldsymbol{\\beta}^{(2)}$ are vectors of\nregression coefficients. Finally, through the introduction of suitable link\nfunctions, $h_1$ and $h_2$, we relate the linear predictors (and consequently\nenvironmental factors) to the probability of absence $\\rho_{t, i}$ and mean\ndensity $\\mu_{t, i}$ as follows:\n$$\n\\begin{aligned}\nh_1(\\rho_{t, i}) & = \\eta^{(1)}_{t, i} \\\\\nh_2(\\mu_{t, i}) & = \\eta^{(2)}_{t, i}.\n\\end{aligned}\n$$ {#eq-sdm-link}\n\n\nThe link functions will ensure that the estimated absence probabilities and mean\ndensities are on the appropriate scale. For instance, $h_1$ should be a function\nthat take a number between 0 and 1 as input and outputs a real number. Common\nchoices for $h_1$ are the $\\mathrm{logit}$ and the $\\mathrm{cloglog}$\nfunctions. The latter is asymmetric and preferred when the proportion of zeros\nis very high or low. For $h_2$, the $\\log$ function is often used as it ensures\nthat the predicted mean densities are positive.\n\n\nThe assumption of independence can be relaxed by introducing random effects into\nthe model.\n\n\n## Dynamic Range Models {#sec-drm}\n\n\nSimilar to SDMs, a DRM based @eq-za_dens also relates the parameters of the\nzero-augmented distribution to environmental covariates. However, the DRMs offer\na more comprehensive approach by incorporating explicit representations of the\nunderlying biological processes that govern species distributions. This\nadvancement enables the integration of expert knowledge and empirical data\nregarding species demography, dispersal patterns, and mechanistic interactions\nwith environmental factors [@pagel2012forecasting].\n\n\nThe assumptions of our DRM are placed on the mean density $\\mu_{t, i}$, with the\nprobability of absence remaining the same as in the SDM. In fact, those\nassumptions can be interpreted as a non-linear function of the environmental\nvariables. In particular, we make assumptions about the (unobserved[^1])\nage-structure behind the densities at a given time point and patch.\n\n\n[^1]: By \"unobserved\", I mean something we do not actually measure or have\n    records of (although it can be inferred to some extent from the length\n    composition)\n\n\nDefine $Y_{a, t, i}$ as a random variable representing the _unobserved_ density\n(individuals per unit of area) for individuals of age $a$, where $a \\in \\{1,\n\\ldots, A\\}$. Similarly, we denote the expected density (or theoretical mean for\na given age, time, and patch) as:\n$$\n\\lambda_{a, t, i} = \\mathbb{E}[Y_{a, t, i}].\n$$\nWe do not observe $Y_{a, i, t}$ and assume the previously defined (overall)\ndensity, which we actually observe, to be the sum of the densities across all\nage groups. In other words, $Y_{t, i} = \\sum_{a} Y_{a, t, i}$. Consequently,\n$$\n\\mu_{t, i} = \\sum_{a} \\lambda_{a, t, i}.\n$$ {#eq-mu-lambda}\n\n\nBiological processes and additional assumptions are encoded through the expected\n\"age densities\" $\\lambda_{a, t, i}$. Some key process we consider are:\nrecruitment, survival, and movement. They are described below.\n\n\n\n### Recruitment {#sec-rec}\n\n\nWe begin by defining the expected density for recruits (fish at age $a = 1$) at\ntime $t$ and patch $i$ as:\n$$\n \\mathbb{E}[Y_{1, i, t}] = \\lambda_{1, i, t} = \\exp \\{\\psi \\},\n$$ {#eq-recruits}\n\nwhere $\\exp\\{ \\psi \\}$ represents the overall mean recruitment per unit of\narea. The assumption in @eq-recruits is quite restrictive. To make the model\nmore realistic, we can replace the constant $\\psi$ with\n\n$$\n\\psi_{t, i} = \\boldsymbol{\\beta}_r \\mathbf{x}^{(r)}_{t, i} + z^{(r)}_{t, i},\n$$ {#eq-lmrec}\n\nwhere $\\mathbf{x}^{(r)}_{t, i}$ is the vector of environmental drivers\nassociated to recruitment at time $t$ and patch $i$, $\\boldsymbol{\\beta}_r$ is a\nvector of corresponding coefficients, and $z^{(r)}_{t, i}$ represent potential\neffects. This depicts a log-linear relationship between recruitment and the\nenvironment, while allowing for the introduction of spatial, temporal, or\nspatio-temporal dependence.\n\n\nTo account for the influence of time on recruitment (or SDM densities), we\nintroduce a random effect in Equation @eq-lmrec. In the current version of the\nmodel, this random effect is the same across all groups for a given time point,\nmeaning $z_{t, i}^{(r)} = z_{t}^{(r)}$ for every $i$. This creates a temporal\ndependence, where the recruitment or density at one point in time is related to\nits value at the previous time point. We model this temporal dependence using an\nautoregressive process of order 1 (AR(1)). Formally, this is defined as:\n\n$$\nz_{t}^{(r)} = \\alpha z_{t - 1}^{(r)} + \\varepsilon_{t},\n$$ {#eq-ar1}\n\nwhere $\\varepsilon_{1}, \\ldots, \\varepsilon_{T}$ are independent and identically\ndistributed residual terms from a zero-mean Normal distribution with variance\n$\\tau^2$, and $\\alpha$ is the temporal autocorrelation parameter. In this model,\nthe recruitment (or density from @eq-linpreds) at time $t$ is a function of its\nvalue at time $t - 1$, plus a random error term. \n\n\n### Survival {#sec-surv}\n\n\nGiven the recruitment, the expected density at age $a$, time $t$, and patch/site\n$i$ is given by\n\n$$\n\\mathbb{E}[Y_{a, t, i}] = \\lambda_{a, t, i} = \\lambda_{a - 1, t - 1, i} s_{a -\n1, t - 1},\n$$\n\nwhere $s_{a, t}$ is a survival rate.\n\n\nWe assume the survival rate (denoted $s_{a, t}$) for fish of age $a$ at time $t$\nto be as follows\n\n$$\ns_{a, t} = \\exp \\{ - (f_{a, t} + m) \\},\n$$ {#eq-surv}\n\nwhere:\n\n* $m$ is the instantaneous natural mortality rate.\n* $f_{a, t}$ is the instantano exploitation rate for age $a$ at time $t$.\n\nBoth $m$ and $f_{a, t}$ may be obtained from stock assessments.\n\n\nFor increased flexibility, we may allow the natural mortality rate ($m$), and\nconsequently the survival rates, to vary by patch/site $i$ and time $t$:\n\n$$\n-m_{t, i} = \\boldsymbol{\\beta}_m \\mathbf{x}^{(m)}_{t,  i} + z^{(m)}_{t, i}\n$$ {#eq-lmsurv}\n\nwhere $\\mathbf{x}^{(m)}_{t, i}$ represents environmental drivers potentially\ndifferent from those affecting recruitment, $\\boldsymbol{\\beta}_m$ are\nassociated coefficients, and $z^{(m)}_{t, i}$ are random effects.\n\n\nIn our current implementation, we do not allow for a random effect on\nmortality/survival yet.\n\n\n### Movement {#sec-movement}\n\n\nFor fish older than a pre-specified age ($a_0$), we incorporate movement between\npatches. Let $\\boldsymbol{\\lambda}_{a, t, \\cdot}$ be a vector of length $P$\n(number of patches) representing the expected density of fish of age $a$ at time\n$t$, with $\\lambda_{a, t, i}$​ denoting the density in patch $i$.\n\nAfter movement, the expected density is:\n\n$$\n\\tilde{\\boldsymbol{\\lambda}}_{a, t,\\cdot} = \\mathbf{M}_a\n\\boldsymbol{\\lambda}_{a - 1, t - 1, \\cdot},\n$$ {#eq-mean-adult-gen}\n\nwhere $\\mathbf{M}_a$ is a $P \\times P$ movement matrix. Each element $\\{i, j\\}$\nof $\\mathbf{M}_a$ represents the probability that a fish of age $a$ moves from\npatch $i$ at time $t - 1$ to patch $j$ at time $t$. For ages $a < a_0$, we\nassume no movement; In other words, the $\\mathbf{M}_{a}$ becomes the identity\nmatrix when $a < a_0$.\n\n\nThe movement matrix $\\mathbf{M}_a$ is derived from a user-provided adjacency\nmatrix $\\mathbf{A}$, which defines connections between patches. In $\\mathbf{A}$,\nthe element $\\{i, j\\}$ is given by\n\n$$\n\\mathbf{A}_{ij} = \\begin{cases}\n1 / N(i), & \\text{ if } i \\sim j, \\\\\n0, & \\text{ otherwise},\n\\end{cases}\n$$\n\nwhere $N(i)$ is the number of neighbors of patch $i$, and $i \\sim j$ indicates\nthat $i$ and $j$ are neighbors (i.e., share borders).\n\n\nWe incorporate a parameter $\\zeta$, which represents the probability of a fish\nstaying in the same patch between two time points. The movement matrix is then\nconstructed as:\n\n$$\n\\mathbf{M}_{a} = \\zeta I_{P} + (1 - \\zeta) \\mathbf{A},\n$$\n\nwhere $I_P$ is a $P \\times P$ identity matrix.\n\n\n### Selectivity at age {#sec-selectivity}\n\n\nOur main data source, trawl surveys, often exhibit age-based selectivity, where\nyounger fish have a lower probability of being caught due to their smaller\nsize. In particular, the probability of capturing an animal of a given length\ngiven it encounters the gear is denoted _selectivity at length_. On the other\nhand, _selectivity at age_ is the probability of capturing a fish of a certain\nage, provided it \"encountered the gear\". We represent selectivity at age by the\nvector $\\mathbf{v} = [v_1, \\ldots, v_A]^\\top$, where $A$ is the total number of\nage groups. Each element $v_a$ of this vector is a value between 0 and 1,\ninclusive, representing the selectivity for age group $a$. Our package does not\nestimate $\\mathbf{v}$ and, unless provided by the user, assumes the selectivity\nis 1 for every age group.\n\n\nWhen a vector $\\mathbf{v}$ is provided, our model assumes:\n\n$$\nY_{t, i} = \\sum_{a} v_a Y_{a, t, i}\n$$\n\nand, consequently,\n\n$$\n\\mu_{t, i} = \\sum_{a} v_a \\lambda_{a, t, i}.\n$$\n\n\nNote that, our model cannot estimate selectivity. Instead, the model assumes it\nis provided as known without error. Of course, this is an oversimplification,\nhowever, we seldomly have the necessary data to estimate selectivity readily\navailable.\n\n\n\n## Bayesian Inference and Forecasting\n\n\nTo complete the Bayesian model specification, we need to specify prior\ndistributions for all model parameters. This involves defining our prior beliefs\nabout the likely values of these parameters before observing any data.\n\n\nFirst, we define the priors for the fixed effects regression coefficients,\ntypically denoted by $\\boldsymbol{\\beta}$ with superscrip. The default priors\nfor these coefficients are uncorrelated zero-mean Normal distributions with\nmarginal variances of 1. The parameter $\\phi$, which controls the scale of the\nnon-zero part of the pdfs in @eq-za_dens (e.g., Log-Normal, Gamma, or\nLog-Logistic), has a Gamma prior with shape and rate parameters equal to 2 and\n1, respectively. In general, the scale of this parameter varies with the pdf\nchosen.\n\n\nNext, we specify the priors for the parameters associated with the AR(1) process\nin Equation @eq-ar1. We take a hierarchical approach, placing a Normal prior on\nthe log of the square root of the conditional variance (i.e., the log of the\nconditional standard deviation). This prior has a default mean of $-2$ and and a\nstandard deviation of 0.25, favoring a model with no AR(1) term. For the\nautocorrelation term, we employ a beta prior on $(\\alpha + 1) / 2$. The default\nparameters on this prior are $0.5$ and $0.5$.\n\n\nLastly, we place a standard normal prior on $\\mathrm{logit}(\\zeta)$.\n\n\nDenote by $\\boldsymbol{\\theta}$ a set containing all the parameters associated\nwith the model we have chosen. The posterior distribution of\n$\\boldsymbol{\\theta}$ (and $\\mathbf{z}$) given the observed data $\\mathbf{y}$\nand environmental factors $\\mathbf{X}$ is\n\n$$\n  \\pi(\\boldsymbol{\\theta}, \\mathbf{z} \\mid \\mathbf{y}) \\propto\n  p(\\mathbf{y} \\mid \\mathbf{X}, \\mathbf{z}, \\boldsymbol{\\beta}, \\boldsymbol{\\gamma})\n  \\pi(\\mathbf{z}  \\mid \\boldsymbol{\\sigma}, \\boldsymbol{\\delta})\n  \\pi(\\boldsymbol{\\theta}),\n$$ {#eq-posterior}\n\nwhere $\\pi(\\cdot)$ denotes prior and posterior distributions of its arguments.\nImportantly, the distribution placed on the random effects $\\mathbf{z}$ also\nfunctions as a prior, as we draw samples from these random effects distribution\nconditioned on the observed data.\n\n\n### Parameter estimation\n\n\nThe estimation of the model parameters is obtained from the posterior\ndistribution defined in @eq-posterior. As the posterior distribution is\nintractable, we use the No-U-Turn [@hoffman2014no] Markov Chain Monte\nCarlo~(MCMC) sampler available in `Stan` to draw samples from it. The No-U-Turn\nalgorithm samples all the model parameters jointly and efficiently exploits the\nparameter space using automatic differentiation. Additionally, it eliminates the\nneed for hand-tuning, making it a highly convenient sampler. We initialize the\nparameters with samples from their respective prior distributions. The latent\nrandom effects are initialized from a standard Gaussian distribution. The number\nof samples and the warm-up period of the MCMC algorithm are application\ndependent. We assess the convergence of the chains using the split-$\\hat{R}$\ndiagnostic [@vehtari2021rank]. Finally, the parameters' point estimates and 95\\%\ncredible intervals~(CI) are obtained as, respectively, the median and\npercentiles ($2.5$ and $97.5$, unless otherwise stated) of the marginal MCMC\nsamples.\n\n\n### Model comparison\n\nThe assessment of goodness-of-fit GoF is carried out using the leave-one-out\ninformation criterion [@vehtari2017practical; LOOIC]. Lower LOOIC values\nindicate a better fit.\n\n\n### Predictions/Forecasting\n\n\nGiven the posterior MCMC samples, we can obtain Monte Carlo samples from the\nposterior predictive distribution under different environmental conditions and\nmake forecasts. Suppose we wish to compute forecasts $k$ time points ahead. We\ndefine an $k$-dimensional variable $\\mathbf{Y}^\\ast$ representing the densities\nat these time points. Assuming environmental at these time points are also\navailable, we can generate predictions accounting for uncertainty using the\nposterior predictive distribution of $\\mathbf{Y}^\\ast$:\n\n$$\n  p(\\mathbf{y}^{\\ast} \\mid \\mathbf{y}) = \\int p(\\mathbf{y}^{\\ast} \\mid\n  \\mathbf{z}^{\\ast}, \\boldsymbol{\\theta})\n  p(\\mathbf{z}^{\\ast} \\mid \\mathbf{z}, \\boldsymbol{\\theta})\n  \\pi(\\boldsymbol{\\theta}\n  \\mid \\mathbf{y}) \\mathrm{d} \\boldsymbol{\\theta},\n$$ {#eq-preds}\n\nwhere\n\n$\\mathbf{z}^\\ast = {(z_{T+1}), \\ldots, z_{T + k}))}^\\top$ is a realization of\nthe AR(1) process at the new time points, and $\\boldsymbol{\\theta}$ represents\nthe model parameters. Moreover, the pdf $p(\\mathbf{y}^{\\ast} \\mid\n\\mathbf{z}^{\\ast}, \\boldsymbol{\\theta})$ can be obtained as in @sec-drm or\n@sec-sdm.\n\n\n## Pontential issues with estimation & Closed formulas for special cases\n\n\nDefine \n\n$$\ns_{a, t, i} = \\exp \\{ m_{i, t} - f_{a, t} \\},\n$$\n\nas the environment dependent survival for age $a$ at time $t$ and site $i$.\n\n\nThen, in the scenario without movement, the expected density for age $a$ at time\n$t$ and site $i$ can be written as:\n\n$$\n\\begin{align}\n\\lambda_{a, t, i} & = \\exp \\{ \\psi_{t, i} + z_{t}^{(r)} \\prod_{k = 1}^{a - 1} s_{k, t, i} \\} \\\\\n& =\n\\exp \\{ \\psi_{t, i} + z_{t}^{(r)} \\} \\exp \\left \\{ (a - 1) m_{t, i}- \\sum_{k =\n1}^{a - 1} f_{a, t} \\right \\}.\n\\end{align}\n$$\n\nTherefore, a closed form for the expected density $\\mu_{i, t}$ is:\n$$\n\\begin{align}\n\\mu_{t, i} & = \\sum_{a = 1}^{A} \\lambda_{a, t, i} \\\\\n& = \\exp \\{ \\psi_{t, i} + z_{t}^{(r)} \\} \\left (1 + \\sum_{a = 2}^{A} \\exp \\left\n\\{ (a - 1) m_{t, i} - \\sum_{k = 1}^{a - 1} f_{k, t} \\right \\} \\right ).\n\\end{align}\n$$\n\nOr, with selectivity,\n\n$$\n\\begin{align}\n\\mu_{t, i} & = \\sum_{a = 1}^{A} v_a \\lambda_{a, t, i} \\\\\n& = \\exp \\{ \\psi_{t, i} + z_{t}^{(r)} \\} \\left (v_1 + \\sum_{a = 2}^{A} v_a \\exp\n\\left \\{ (a - 1) m_{t, i} - \\sum_{k = 1}^{a - 1} f_{k, t} \\right \\} \\right ).\n\\end{align}\n$$\n\n## References\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}